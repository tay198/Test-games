<!DOCTYPE html>
<html>
<head>
  <title>Taylan's Enhanced Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      --original-bg: linear-gradient(135deg, #e0f7fa, #c5e1a5);
      background: var(--original-bg);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      padding-top: 10px;
    }
    h1 {
      font-size: 1.8em;
      margin-top: 0;
      margin-bottom: 8px;
    }
    #authContainer {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 8px;
        text-align: center;
        width: 90vw;
        max-width: 450px;
    }
    #authContainer input[type="email"],
    #authContainer input[type="password"] {
        margin-bottom: 5px;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        width: calc(100% - 20px);
    }
    #authContainer button {
        padding: 8px 15px;
        font-size: 0.9em;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    #authContainer button:hover {
        background-color: #218838;
    }
    #logoutButton {
        background-color: #dc3545 !important;
    }
    #logoutButton:hover {
        background-color: #c82333 !important;
    }
    #scoreBoard, #highScoreBoard, #timer, #combo {
      margin: 3px;
      font-size: 17px;
      color: #333;
      min-height: 22px;
    }
    #highScoreBoard { color: #b8860b; }
    #combo.active {
        animation: comboPulse 0.3s ease-in-out;
        font-weight: bold;
    }
    @keyframes comboPulse {
        0% { transform: scale(1.1); color: gold; }
        50% { transform: scale(1.25); color: orange; }
        100% { transform: scale(1.1); color: gold; }
    }

    #visualTimer {
        width: 90vw;
        max-width: 450px;
        height: 10px;
        background-color: #ccc;
        border-radius: 5px;
        margin-bottom: 8px;
        overflow: hidden;
        border: 1px solid #bbb;
    }
    #visualTimerBar {
        width: 100%;
        height: 100%;
        background-color: #4CAF50;
        border-radius: 5px;
        transition: width 0.5s linear;
    }

    #gameArea {
      position: relative;
      width: 90vw;
      height: 60vh;
      max-width: 450px;
      max-height: 600px;
      background-color: #fff;
      border: 2px solid #333;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .item-face {
      position: absolute;
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s ease-out;
    }
    .item-face:active {
        transform: scale(0.9);
    }
    .stacey-clicked {
        animation: staceyGotClicked 0.3s ease-out forwards;
    }
    @keyframes staceyGotClicked {
        0% { transform: scale(1.1); opacity: 1;}
        100% { transform: scale(0.5); opacity: 0;}
    }

    .sparkle {
      animation: sparkle 0.6s ease-out forwards;
    }
    @keyframes sparkle {
      0% { transform: scale(1) rotate(0deg); opacity: 1; filter: brightness(1.2); }
      50% { transform: scale(1.6) rotate(15deg); opacity: 0.7; filter: brightness(1.5) drop-shadow(0 0 5px gold); }
      100% { transform: scale(0.8) rotate(-15deg); opacity: 0; filter: brightness(0.8); }
    }

    #startButton, #showInstructionsButton {
      margin-top: 8px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #startButton:hover, #showInstructionsButton:hover {
        background-color: #0056b3;
    }
    #startButton:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
    #gameOverMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: white;
      background-color: rgba(180, 0, 0, 0.85);
      padding: 20px;
      border-radius: 10px;
      font-weight: bold;
      z-index: 10000;
      display: none;
      text-align: center;
      line-height: 1.4;
    }
    .no-symbol-overlay {
      position: absolute;
      width: 70px;
      height: 70px;
      background-image: url('https://i.imgur.com/AhrFSJL.jpeg');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 500;
      pointer-events: none;
      opacity: 0.8;
    }
    #screenFlashOverlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: red;
        opacity: 0;
        z-index: 499;
        pointer-events: none;
        animation: screenFlashAnim 0.4s ease-out;
    }
    @keyframes screenFlashAnim {
        0% { opacity: 0.6; }
        100% { opacity: 0; }
    }

    .score-popup {
      position: absolute;
      font-size: 22px;
      font-weight: bold;
      color: gold;
      text-shadow: 1px 1px 2px black;
      pointer-events: none;
      animation: scorePopupAnim 0.7s ease-out forwards;
      z-index: 100;
    }
    @keyframes scorePopupAnim {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
    }

    #instructionModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none; justify-content: center; align-items: center;
      z-index: 20000; padding: 15px; box-sizing: border-box;
    }
    #instructionModalContent {
      background-color: #fff; padding: 25px 30px; border-radius: 10px;
      text-align: center; max-width: 400px; width: 90%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #instructionModalContent h2 { margin-top: 0; color: #333; }
    #instructionModalContent p { margin-bottom: 20px; font-size: 1em; line-height: 1.5; color: #555; }
    #closeInstructionsButton {
      padding: 12px 25px; font-size: 1em; background-color: #007bff;
      color: white; border: none; border-radius: 5px; cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #closeInstructionsButton:hover { background-color: #0056b3; }

    #jailBarsOverlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: none; justify-content: space-around; 
      overflow: hidden; z-index: 9000; pointer-events: none;
      background-color: rgba(0, 0, 0, 0.15); 
      padding-left: 1%; 
      padding-right: 1%;
      box-sizing: border-box;
    }
    #jailBarsOverlay.active { display: flex; }

    .jail-bar {
      background: linear-gradient(to right, #7d7d7d 0%, #c0c0c0 30%, #d3d3d3 50%, #c0c0c0 70%, #7d7d7d 100%); 
      border-left: 1px solid #666; 
      border-right: 1px solid #e0e0e0; 
      width: 5%; 
      max-width: 20px; 
      min-width: 8px;  
      height: 0%; 
      animation: dropJailBar 0.6s forwards ease-in-out;
      box-sizing: border-box;
      box-shadow: inset 1px 0 1px rgba(255,255,255,0.3), 
                  inset -1px 0 1px rgba(0,0,0,0.3),  
                  1px 0 3px rgba(0, 0, 0, 0.5);  
      border-radius: 2px 2px 0 0; 
    }

    .jail-bar:nth-child(1) { animation-delay: 0s; }
    .jail-bar:nth-child(2) { animation-delay: 0.05s; }
    .jail-bar:nth-child(3) { animation-delay: 0.1s; }
    .jail-bar:nth-child(4) { animation-delay: 0.15s; }
    .jail-bar:nth-child(5) { animation-delay: 0.2s; }
    .jail-bar:nth-child(6) { animation-delay: 0.25s; }
    .jail-bar:nth-child(7) { animation-delay: 0.3s; }

    @keyframes dropJailBar {
      from { height: 0%; transform: translateY(-100%);}
      to   { height: 100%; transform: translateY(0); }
    }

    .powerup-icon {
        border: 3px solid gold !important;
        box-shadow: 0 0 10px gold;
    }
    #activePowerUpsDisplay {
        margin-top: 5px;
        font-size: 0.9em;
        color: #333;
        min-height: 20px;
        text-align: center;
    }
  </style>
</head>
<body>

  <div id="authContainer">
    <div id="userAuthStatus" style="margin-bottom: 10px; font-weight: bold;">Loading user status...</div>
    <div id="loginForm">
      <h3>Login</h3>
      <input type="email" id="loginEmail" placeholder="Email" required><br>
      <input type="password" id="loginPassword" placeholder="Password" required><br>
      <button id="loginButton" style="margin-top: 5px;">Login</button>
    </div>
    <div id="signupForm" style="margin-top:10px;">
      <h3>Sign Up</h3>
      <input type="email" id="signupEmail" placeholder="Email" required><br>
      <input type="password" id="signupPassword" placeholder="Password" required><br>
      <button id="signupButton" style="margin-top: 5px;">Sign Up</button>
    </div>
    <button id="logoutButton" style="margin-top: 10px; display: none;">Logout</button>
  </div>
  <h1>Taylan's Enhanced Game</h1>
  <div id="scoreBoard">Score: <span id="score">0</span></div>
  <div id="highScoreBoard">High Score: <span id="highScore">0</span></div>
  <div id="timer">Time: <span id="timeLeft">30</span>s</div>
  <div id="visualTimer"><div id="visualTimerBar"></div></div>
  <div id="combo" style="min-height: 24px;"></div>
  <div id="activePowerUpsDisplay"></div>

  <div id="gameArea">
    <div id="gameOverMessage"></div>
    <div id="jailBarsOverlay">
      <div class="jail-bar"></div><div class="jail-bar"></div><div class="jail-bar"></div>
      <div class="jail-bar"></div><div class="jail-bar"></div><div class="jail-bar"></div>
      <div class="jail-bar"></div>
    </div>
  </div>

  <audio id="gameMusic" src="https://github.com/tay198/Taylans-game-music/raw/refs/heads/main/AC_250601194725.mp3" loop></audio>
  <audio id="gameOverSound" src="https://github.com/tay198/Taylans-game-music/raw/refs/heads/main/END%20OF%20GAME%20SOUND.mp3"></audio>
  <audio id="staceyClickSound" src="https://github.com/tay198/Stacey-saying-owe/raw/refs/heads/main/Stacey%20saying%20ouch.m4a"></audio>
  <audio id="jakePenaltySound" src="YOUR_JAKE_PENALTY_SOUND.mp3"></audio>
  <audio id="powerUpSound" src="YOUR_POWERUP_COLLECT_SOUND.mp3"></audio>
  <audio id="bystanderSound" src="YOUR_BYSTANDER_HIT_SOUND.mp3"></audio>
  <audio id="comboSound" src="YOUR_COMBO_SOUND.mp3"></audio>
  <audio id="jailBarSound" src="YOUR_JAIL_BAR_SLAM_SOUND.mp3"></audio>

  <button id="startButton">Start Game</button>
  <button id="showInstructionsButton">How to Play</button>

  <div id="instructionModal">
    <div id="instructionModalContent">
      <h2>How to Play Taylan's Game!</h2>
      <p>Stacey's under arrest, catch her before she runs away! But if you accidentally hit Jake, you'll be under arrest for killing a cop! Who's side are you on?</p>
      <button id="closeInstructionsButton">Got It!</button>
    </div>
  </div>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      getDoc 
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBbYpT5ayO9ndNb34YkndY-UEobEPjoXGo", //REPLACE WITH YOUR ACTUAL API KEY
      authDomain: "taylans-game-9470b.firebaseapp.com",
      projectId: "taylans-game-9470b",
      storageBucket: "taylans-game-9470b.firebasestorage.app",
      messagingSenderId: "556518485303",
      appId: "1:556518485303:web:dd605fa83eabc3013cfeb2",
      measurementId: "G-B78NZZWVT9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Expose functions to global scope for the game script
    window.fbAuth = {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      auth 
    };
    window.fbDb = {
      doc,
      setDoc,
      getDoc,
      db 
    };
  </script>

  <script>
    const gameArea = document.getElementById('gameArea');
    const scoreDisplay = document.getElementById('score');
    const highScoreDisplay = document.getElementById('highScore');
    const timeDisplay = document.getElementById('timeLeft');
    const visualTimerBar = document.getElementById('visualTimerBar');
    const comboDisplay = document.getElementById('combo');
    const gameOverMessage = document.getElementById('gameOverMessage');
    const startButton = document.getElementById('startButton');
    const showInstructionsButton = document.getElementById('showInstructionsButton');
    const activePowerUpsDisplay = document.getElementById('activePowerUpsDisplay');

    const music = document.getElementById('gameMusic');
    const gameOverSoundEffect = document.getElementById('gameOverSound');
    const staceyClickSfx = document.getElementById('staceyClickSound');
    const jakePenaltySfx = document.getElementById('jakePenaltySound');
    const powerUpSfx = document.getElementById('powerUpSound');
    const bystanderSfx = document.getElementById('bystanderSound');
    const comboSfx = document.getElementById('comboSound');
    const jailBarSfx = document.getElementById('jailBarSound');

    const instructionModal = document.getElementById('instructionModal');
    const closeInstructionsButton = document.getElementById('closeInstructionsButton');
    const jailBarsOverlay = document.getElementById('jailBarsOverlay');

    const staceyURL = 'https://i.imgur.com/qDTf6hn.jpeg';
    const jakeURL = 'https://i.imgur.com/hDQyFFS.jpeg';
    const bystanderURL = 'https://via.placeholder.com/60/808080/FFFFFF?text=Byst';
    const timePowerUpURL = 'https://via.placeholder.com/60/0000FF/FFFFFF?text=Time';
    const scorePowerUpURL = 'https://via.placeholder.com/60/FFD700/000000?text=Score';

    const gameSettings = {
        initialTime: 30,
        baseSpawnInterval: 950,
        minSpawnInterval: 400,
        jakeBaseProb: 0.20,
        jakeMaxProb: 0.40,
        powerUpProb: 0.10,
        bystanderProb: 0.15,
        pointsPerStacey: 5,
        comboBonusMultiplier: 2,
        bystanderPenalty: 10,
        timePowerUpValue: 5,
        scorePowerUpDuration: 5000,
        scorePowerUpMultiplier: 2,
        difficultyScoreThreshold: 100,
        itemBaseSpeed: 4.5,
        itemSpeedVariance: 3.0
    };

    let score = 0;
    let highScore = 0;
    let timeLeft = gameSettings.initialTime;
    let gameInterval, spawnIntervalId, animationIntervalId;
    let gameActive = false;
    let hitJakeInGameOver = false;
    let comboCount = 0;
    let comboTimeout;
    let flickerInterval = null;
    let originalBodyBackground = getComputedStyle(document.body).getPropertyValue('--original-bg');
    let isFlickerRed = false;
    let gameOverFlickerTimeout = null; 
    let currentSpawnInterval = gameSettings.baseSpawnInterval;
    let currentJakeProb = gameSettings.jakeBaseProb;
    let activeScoreMultiplier = 1;
    let scoreMultiplierTimeout;
    let currentUserId = null; // To store Firebase User ID

    // --- Firebase Auth & DB Interaction ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!window.fbAuth || !window.fbDb) {
            console.error("Firebase services not available. Ensure Firebase module script runs first and exposes fbAuth/fbDb.");
            // Fallback for user status display if Firebase isn't ready
            const userAuthStatusEl = document.getElementById('userAuthStatus');
            if (userAuthStatusEl) userAuthStatusEl.textContent = "Firebase not loaded. Please refresh.";
            return;
        }

        const authInstance = window.fbAuth.auth;
        const dbInstance = window.fbDb.db;

        const userAuthStatus = document.getElementById('userAuthStatus');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const logoutButton = document.getElementById('logoutButton');
        
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');

        const signupEmailInput = document.getElementById('signupEmail');
        const signupPasswordInput = document.getElementById('signupPassword');
        const signupButton = document.getElementById('signupButton');

        window.fbAuth.onAuthStateChanged(authInstance, user => {
            if (user) {
                currentUserId = user.uid;
                userAuthStatus.textContent = `Logged in as: ${user.email}`;
                loginForm.style.display = 'none';
                signupForm.style.display = 'none';
                logoutButton.style.display = 'inline-block';
                console.log("User logged in:", user.email);
                loadHighScore(); 
            } else {
                currentUserId = null;
                userAuthStatus.textContent = 'Not logged in';
                loginForm.style.display = 'block';
                signupForm.style.display = 'block';
                logoutButton.style.display = 'none';
                console.log("User logged out");
                highScore = 0; 
                if(highScoreDisplay) highScoreDisplay.textContent = highScore; 
                loadHighScore(); // Load local if preferred
            }
             // Enable start button regardless of login status for now
             if(startButton) startButton.disabled = false;
        });

        signupButton.addEventListener('click', () => {
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            if (!email || !password) { alert("Please enter email and password."); return; }
            window.fbAuth.createUserWithEmailAndPassword(authInstance, email, password)
                .then(userCredential => {
                    console.log("Signed up:", userCredential.user.email);
                    const userDocRef = window.fbDb.doc(dbInstance, "userScores", userCredential.user.uid);
                    return window.fbDb.setDoc(userDocRef, { highScore: 0, email: userCredential.user.email }, { merge: true });
                })
                .then(() => {
                     console.log("Initial user score document created/merged.");
                     signupEmailInput.value = ''; // Clear fields
                     signupPasswordInput.value = '';
                })
                .catch(error => {
                    console.error("Signup error:", error.message);
                    alert("Signup failed: " + error.message);
                });
        });

        loginButton.addEventListener('click', () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) { alert("Please enter email and password."); return; }
            window.fbAuth.signInWithEmailAndPassword(authInstance, email, password)
                .then(userCredential => {
                    console.log("Logged in:", userCredential.user.email);
                    loginEmailInput.value = ''; // Clear fields
                    loginPasswordInput.value = '';
                })
                .catch(error => {
                    console.error("Login error:", error.message);
                    alert("Login failed: " + error.message);
                });
        });

        logoutButton.addEventListener('click', () => {
            window.fbAuth.signOut(authInstance).catch(error => {
                console.error("Logout error:", error.message);
            });
        });
    }); // End of DOMContentLoaded for Firebase Auth UI

    async function saveScoreToFirebase(userId, newScoreToSave) {
        if (!userId || !window.fbDb || !window.fbDb.db) {
            console.log("No user logged in or Firebase DB not ready. Score not saved to Firebase.");
            return;
        }
        console.log(`Attempting to save score ${newScoreToSave} for user ${userId}`);
        try {
            const userDocRef = window.fbDb.doc(window.fbDb.db, "userScores", userId);
            const docSnap = await window.fbDb.getDoc(userDocRef);
            let currentFirebaseHighScore = 0;
            if (docSnap.exists()) {
                currentFirebaseHighScore = docSnap.data().highScore || 0;
            }
            
            if (newScoreToSave > currentFirebaseHighScore) {
                await window.fbDb.setDoc(userDocRef, { highScore: newScoreToSave }, { merge: true });
                console.log("New high score saved to Firebase:", newScoreToSave);
                highScore = newScoreToSave; 
                if(highScoreDisplay) highScoreDisplay.textContent = highScore;
            } else {
                console.log(`Score ${newScoreToSave} not higher than Firebase high score ${currentFirebaseHighScore}. Not updated.`);
            }
        } catch (error) {
            console.error("Error saving score to Firebase:", error);
        }
    }

    async function loadHighScoreFromFirebase(userId) {
        if (!userId || !window.fbDb || !window.fbDb.db) {
            console.log("No user logged in or Firebase DB not ready. Cannot load score from Firebase.");
            return 0;
        }
        try {
            const userDocRef = window.fbDb.doc(window.fbDb.db, "userScores", userId);
            const docSnap = await window.fbDb.getDoc(userDocRef);
            if (docSnap.exists()) {
                const firebaseHighScore = docSnap.data().highScore || 0;
                console.log("Score loaded from Firebase:", firebaseHighScore);
                return firebaseHighScore;
            } else {
                console.log("No score document found for user in Firebase. Creating one with highScore 0.");
                await window.fbDb.setDoc(userDocRef, { highScore: 0 }); // Create doc if not exists
                return 0;
            }
        } catch (error) {
            console.error("Error loading score from Firebase:", error);
            return 0; 
        }
    }
    // --- End Firebase ---

    function playSound(soundElement) {
        if (soundElement && soundElement.src && soundElement.src !== window.location.href && !soundElement.src.endsWith('null') && !soundElement.src.endsWith('undefined') && !soundElement.src.includes('YOUR_')) {
            soundElement.currentTime = 0;
            soundElement.play().catch(error => console.warn("Audio play error:", error.message, "for", soundElement.src));
        }
    }

    function createScorePopup(value, element) {
        const popup = document.createElement('div');
        popup.textContent = (value > 0 ? '+' : '') + value;
        popup.className = 'score-popup';
        popup.style.color = value > 0 ? 'gold' : 'red';
        const itemRect = element.getBoundingClientRect();
        const gameAreaRect = gameArea.getBoundingClientRect();
        popup.style.left = (itemRect.left - gameAreaRect.left + element.offsetWidth / 2 - 15) + 'px';
        popup.style.top = (itemRect.top - gameAreaRect.top - 10) + 'px';
        gameArea.appendChild(popup);
        setTimeout(() => { if (popup.parentNode) popup.remove(); }, 700);
    }

    function updateActivePowerUpsDisplay() {
        let displayHTML = "";
        if (activeScoreMultiplier > 1) { displayHTML += `Double Score Active! `; }
        activePowerUpsDisplay.innerHTML = displayHTML;
    }

    function showInstructions() {
      instructionModal.style.display = 'flex';
      if(startButton) startButton.disabled = true;
    }
    function hideInstructions() {
      instructionModal.style.display = 'none';
      localStorage.setItem('instructionsShown', 'true');
      if(startButton && !gameActive) startButton.disabled = false; // Only enable if game not active
    }
    
    // Ensure loadHighScore is async to work with Firebase
    async function loadHighScore() {
        if (currentUserId) { // Check if a user is logged in (Firebase)
            highScore = await loadHighScoreFromFirebase(currentUserId);
        } else {
            // Fallback to localStorage if no user logged in
            highScore = parseInt(localStorage.getItem('taylanGameHighScore') || '0');
            console.log("Loaded high score from localStorage (no user logged in).");
        }
        if(highScoreDisplay) highScoreDisplay.textContent = highScore;
    }

    // Ensure saveHighScore uses the global score variable
    function saveHighScore() { 
        if (currentUserId) { // Check if a user is logged in (Firebase)
            saveScoreToFirebase(currentUserId, score); 
        } else {
            // Fallback or if you want to always save locally too for non-logged-in users
            const localHighScore = parseInt(localStorage.getItem('taylanGameHighScore') || '0');
            if (score > localHighScore) {
                localStorage.setItem('taylanGameHighScore', score.toString());
                console.log("Saved high score to localStorage (no user logged in).");
                if(!currentUserId) { // Update display only if Firebase didn't handle it
                    highScore = score;
                   if(highScoreDisplay) highScoreDisplay.textContent = highScore;
                }
            }
        }
    }


    window.addEventListener('load', () => {
      // loadHighScore(); // Moved to be called after auth state is known or DOMContentLoaded
      if (localStorage.getItem('instructionsShown') !== 'true') {
        showInstructions();
      } else {
        if(startButton) startButton.disabled = false;
      }
      if (music) music.volume = 0.3; 
      if (staceyClickSfx) staceyClickSfx.volume = 1.0; 
      if (gameOverSoundEffect) gameOverSoundEffect.volume = 0.6;
      if (staceyClickSfx.src && staceyClickSfx.src !== window.location.href && !staceyClickSfx.src.includes("YOUR_")) {
        staceyClickSfx.preload = 'auto';
        staceyClickSfx.load();
      }
      // Initial call to loadHighScore is now better handled by onAuthStateChanged or DOMContentLoaded
      // but for non-logged-in state, ensure it's loaded once.
      if (!currentUserId) {
          loadHighScore();
      }
    });

    closeInstructionsButton.addEventListener('click', hideInstructions);
    showInstructionsButton.addEventListener('click', showInstructions);

    function updateDifficulty() {
        const difficultyFactor = Math.floor(score / gameSettings.difficultyScoreThreshold);
        currentSpawnInterval = Math.max(gameSettings.minSpawnInterval, gameSettings.baseSpawnInterval - difficultyFactor * 50);
        currentJakeProb = Math.min(gameSettings.jakeMaxProb, gameSettings.jakeBaseProb + difficultyFactor * 0.02);
        if (gameActive && spawnIntervalId) {
            clearInterval(spawnIntervalId);
            spawnIntervalId = setInterval(spawnItem, currentSpawnInterval);
        }
    }

    function updateItemPositions() {
        if (!gameActive) return;
        const items = gameArea.querySelectorAll('.item-face');
        const gameAreaWidth = gameArea.clientWidth;
        const gameAreaHeight = gameArea.clientHeight;
        items.forEach(item => {
            if (item.dx === 0 && item.dy === 0) return; 
            if (!item.hasOwnProperty('dx') || !item.hasOwnProperty('dy')) return;
            let currentX = parseFloat(item.style.left);
            let currentY = parseFloat(item.style.top);
            const itemWidth = item.offsetWidth;
            const itemHeight = item.offsetHeight;
            currentX += item.dx;
            currentY += item.dy;
            if (currentX <= 0) { currentX = 0; item.dx *= -1; } 
            else if (currentX + itemWidth >= gameAreaWidth) { currentX = gameAreaWidth - itemWidth; item.dx *= -1; }
            if (currentY <= 0) { currentY = 0; item.dy *= -1; } 
            else if (currentY + itemHeight >= gameAreaHeight) { currentY = gameAreaHeight - itemHeight; item.dy *= -1; }
            item.style.left = currentX + 'px';
            item.style.top = currentY + 'px';
        });
    }

    function spawnItem() {
      if (!gameActive) return;
      let itemType = 'stacey';
      let itemURL = staceyURL;
      let isPowerUp = false;
      const rand = Math.random();
      if (rand < currentJakeProb) { itemType = 'jake'; itemURL = jakeURL; } 
      else if (rand < currentJakeProb + gameSettings.powerUpProb) {
        isPowerUp = true;
        if (Math.random() < 0.5) { itemType = 'timePowerUp'; itemURL = timePowerUpURL; } 
        else { itemType = 'scorePowerUp'; itemURL = scorePowerUpURL; }
      } else if (rand < currentJakeProb + gameSettings.powerUpProb + gameSettings.bystanderProb) {
        itemType = 'bystander'; itemURL = bystanderURL;
      }

      if (itemURL.includes('YOUR_') && itemURL.includes('_IMAGE.png')) {
          console.warn(`Skipping spawn for ${itemType} due to placeholder image URL: ${itemURL}`); return;
      }
      if (itemURL.includes('via.placeholder.com') && (itemType === 'jake' || itemType === 'stacey')) {
           console.warn(`Skipping critical item ${itemType} due to placeholder image URL from via.placeholder.com: ${itemURL}`); return;
      }

      const img = document.createElement('img');
      img.src = itemURL; img.alt = itemType; img.classList.add('item-face');
      if (isPowerUp) img.classList.add('powerup-icon');
      img.setAttribute('draggable', 'false'); img.dataset.itemType = itemType;
      img.onerror = function() {
          console.error(`Error loading image: ${itemURL} for item type: ${itemType}. Removing element.`);
          if(itemType === 'jake') console.error("CRITICAL: Jake image failed to load!");
          if (img.parentNode) img.remove();
      };
      const itemSize = 60;
      const x = Math.random() * (gameArea.clientWidth - itemSize);
      const y = Math.random() * (gameArea.clientHeight - itemSize);
      img.style.left = x + 'px'; img.style.top = y + 'px';
      const speed = gameSettings.itemBaseSpeed + Math.random() * gameSettings.itemSpeedVariance;
      const angle = Math.random() * 2 * Math.PI;
      img.dx = Math.cos(angle) * speed; img.dy = Math.sin(angle) * speed;
      if (itemType === 'jake') { 
          img.dx = Math.cos(angle) * (gameSettings.itemBaseSpeed + 0.5 + Math.random() * gameSettings.itemSpeedVariance);
          img.dy = Math.sin(angle) * (gameSettings.itemBaseSpeed + 0.5 + Math.random() * gameSettings.itemSpeedVariance);
      }

      img.addEventListener('click', (event) => {
        if (!gameActive || (img.dx === 0 && img.dy === 0 && !img.classList.contains('stacey-clicked'))) return;
        img.dx = 0; img.dy = 0;
        const clickedItemType = img.dataset.itemType;

        if (clickedItemType === 'jake') {
          const noSymbol = document.createElement('div'); noSymbol.className = 'no-symbol-overlay';
          const itemRect = img.getBoundingClientRect(); const gameAreaRect = gameArea.getBoundingClientRect();
          noSymbol.style.left = (itemRect.left - gameAreaRect.left + (img.offsetWidth / 2) - 35) + 'px';
          noSymbol.style.top = (itemRect.top - gameAreaRect.top + (img.offsetHeight / 2) - 35) + 'px';
          gameArea.appendChild(noSymbol);
          const flash = document.createElement('div'); flash.id = 'screenFlashOverlay';
          if (document.getElementById('screenFlashOverlay')) { document.getElementById('screenFlashOverlay').remove(); }
          gameArea.appendChild(flash);
          if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
          hitJakeInGameOver = true; endGame();
        } else if (clickedItemType === 'stacey') {
          playSound(staceyClickSfx); img.classList.add('stacey-clicked');
          comboCount++;
          const pointsEarned = gameSettings.pointsPerStacey * (comboCount > 1 ? gameSettings.comboBonusMultiplier : 1) * activeScoreMultiplier;
          score += pointsEarned; scoreDisplay.textContent = score;
          createScorePopup(pointsEarned, img);
          comboDisplay.textContent = comboCount > 1 ? `Combo: ${comboCount}x!` : '';
          if (comboCount > 1) {
            playSound(comboSfx); comboDisplay.classList.add('active');
            setTimeout(() => comboDisplay.classList.remove('active'), 300);
          }
          clearTimeout(comboTimeout);
          comboTimeout = setTimeout(() => { comboCount = 0; comboDisplay.textContent = ''; }, 2000);
          if (navigator.vibrate) navigator.vibrate(30); updateDifficulty();
        } else if (clickedItemType === 'bystander') {
            playSound(bystanderSfx); score = Math.max(0, score - gameSettings.bystanderPenalty);
            scoreDisplay.textContent = score; createScorePopup(-gameSettings.bystanderPenalty, img);
            comboCount = 0; comboDisplay.textContent = '';
            if (navigator.vibrate) navigator.vibrate(50);
        } else if (clickedItemType === 'timePowerUp') {
            playSound(powerUpSfx); timeLeft += gameSettings.timePowerUpValue; timeDisplay.textContent = timeLeft;
            const currentMaxTime = Math.max(gameSettings.initialTime, timeLeft);
            visualTimerBar.style.width = Math.min(100, (timeLeft / currentMaxTime) * 100) + '%';
            createScorePopup(`+${gameSettings.timePowerUpValue}s`, img);
        } else if (clickedItemType === 'scorePowerUp') {
            playSound(powerUpSfx); activeScoreMultiplier = gameSettings.scorePowerUpMultiplier;
            updateActivePowerUpsDisplay(); createScorePopup(`x${gameSettings.scorePowerUpMultiplier} Score!`, img);
            clearTimeout(scoreMultiplierTimeout);
            scoreMultiplierTimeout = setTimeout(() => { activeScoreMultiplier = 1; updateActivePowerUpsDisplay(); }, gameSettings.scorePowerUpDuration);
        }
        img.style.pointerEvents = 'none'; 
        if (clickedItemType !== 'stacey') { 
            setTimeout(() => { if (img.parentNode) img.remove(); }, isPowerUp ? 100 : 300); 
        } else {
             setTimeout(() => { if (img.parentNode) img.remove(); }, 300); 
        }
      });
      gameArea.appendChild(img);
      if (itemType !== 'jake') {
        setTimeout(() => {
          if (gameArea.contains(img) && (img.dx !== 0 || img.dy !== 0) && img.style.pointerEvents !== 'none') {
              if (itemType === 'stacey') { 
                  comboCount = 0; comboDisplay.textContent = ''; clearTimeout(comboTimeout);
              }
              if (img.parentNode === gameArea) { gameArea.removeChild(img); }
          }
        }, itemType === 'bystander' || isPowerUp ? 3000 : 2500); 
      }
    }

    function updateTimer() {
      timeLeft--; timeDisplay.textContent = timeLeft;
      const percentageLeft = Math.max(0,(timeLeft / gameSettings.initialTime) * 100); 
      visualTimerBar.style.width = percentageLeft + '%';
      if (percentageLeft < 25) visualTimerBar.style.backgroundColor = '#f44336';
      else if (percentageLeft < 50) visualTimerBar.style.backgroundColor = '#ffeb3b'; 
      else visualTimerBar.style.backgroundColor = '#4CAF50';
      if (timeLeft <= 0) { timeLeft = 0; timeDisplay.textContent = timeLeft; endGame(); }
    }

    function toggleBackgroundColorFlicker() {
        if (isFlickerRed) { document.body.style.background = 'rgba(0,0,255,0.3)'; } 
        else { document.body.style.background = 'rgba(255,0,0,0.3)'; }
        isFlickerRed = !isFlickerRed;
    }

    function startGame() {
      if (gameOverFlickerTimeout) clearTimeout(gameOverFlickerTimeout);
      if (flickerInterval) clearInterval(flickerInterval); 
      document.body.style.background = originalBodyBackground; 
      gameOverSoundEffect.pause(); gameOverSoundEffect.currentTime = 0;
      if (jailBarSfx.src && jailBarSfx.src !== window.location.href && !jailBarSfx.src.includes('YOUR_')) {
        jailBarSfx.pause(); jailBarSfx.currentTime = 0;
      }
      if (jakePenaltySfx.src && jakePenaltySfx.src !== window.location.href && !jakePenaltySfx.src.includes('YOUR_')) {
        jakePenaltySfx.pause(); jakePenaltySfx.currentTime = 0;
      }
      gameActive = true; hitJakeInGameOver = false; score = 0;
      timeLeft = gameSettings.initialTime; comboCount = 0; activeScoreMultiplier = 1;
      currentSpawnInterval = gameSettings.baseSpawnInterval; currentJakeProb = gameSettings.jakeBaseProb;
      scoreDisplay.textContent = score; timeDisplay.textContent = timeLeft;
      visualTimerBar.style.width = '100%'; visualTimerBar.style.backgroundColor = '#4CAF50';
      comboDisplay.textContent = ''; gameOverMessage.style.display = 'none';
      jailBarsOverlay.classList.remove('active');
      document.querySelectorAll('#jailBarsOverlay .jail-bar').forEach(b => {
          b.style.animation = 'none'; b.offsetHeight; b.style.animation = ''; b.style.height = '0%'; 
      });
      updateActivePowerUpsDisplay(); clearTimeout(scoreMultiplierTimeout);
      startButton.textContent = 'Game in Progress...'; startButton.disabled = true;
      showInstructionsButton.disabled = true; clearGameElements();
      if (music.src && music.src !== window.location.href && !music.src.includes('YOUR_')) {
        music.play().catch(error => console.warn("Music play error:", error.message));
      }
      isFlickerRed = false; flickerInterval = setInterval(toggleBackgroundColorFlicker, 300); 
      if(spawnIntervalId) clearInterval(spawnIntervalId);
      spawnIntervalId = setInterval(spawnItem, currentSpawnInterval);
      if(gameInterval) clearInterval(gameInterval);
      gameInterval = setInterval(updateTimer, 1000);
      if(animationIntervalId) clearInterval(animationIntervalId);
      animationIntervalId = setInterval(updateItemPositions, 50); 
    }

    function endGame() {
      const wasAlreadyOver = !gameActive; gameActive = false; 
      clearInterval(spawnIntervalId); clearInterval(gameInterval);
      if (animationIntervalId) clearInterval(animationIntervalId); 
      clearTimeout(comboTimeout); clearTimeout(scoreMultiplierTimeout);
      if (flickerInterval) clearInterval(flickerInterval);
      if (gameOverFlickerTimeout) clearTimeout(gameOverFlickerTimeout);
      saveHighScore(); // This will now try to save to Firebase if user is logged in

      if (hitJakeInGameOver) {
          gameOverMessage.innerHTML = `YOU KILLED JAKE!<br>YOUR UNDER ARREST FOR KILLING A COP!<br>Final Score: ${score}`;
          playSound(jailBarSfx); 
          jailBarsOverlay.classList.add('active');
          document.querySelectorAll('#jailBarsOverlay .jail-bar').forEach(b => {
            b.style.animation = 'none'; b.offsetHeight; 
            b.style.animationName = 'dropJailBar'; b.style.animationDuration = '0.6s';
            b.style.animationTimingFunction = 'ease-in-out'; b.style.animationFillMode = 'forwards';
            const index = Array.from(b.parentNode.children).indexOf(b);
            b.style.animationDelay = `${index * 0.05}s`;
          });
      } else {
          gameOverMessage.innerHTML = `Time's Up!<br>You caught her, Stacey's under arrest!!<br>Final Score: ${score}`;
      }
      gameOverMessage.style.display = 'block';
      startButton.textContent = 'Restart Game'; startButton.disabled = false;
      showInstructionsButton.disabled = false; 
      if (music.src && music.src !== window.location.href && !music.src.includes('YOUR_')) {
        music.pause(); music.currentTime = 0;
      }
      if (!wasAlreadyOver && hitJakeInGameOver) { playSound(gameOverSoundEffect); }
      flickerInterval = setInterval(toggleBackgroundColorFlicker, 300); 
      gameOverFlickerTimeout = setTimeout(() => {
          clearInterval(flickerInterval); 
          if (!gameActive) { document.body.style.background = originalBodyBackground; }
      }, 10000); 
    }

    function clearGameElements() {
        gameArea.querySelectorAll('.item-face, .no-symbol-overlay, .score-popup, #screenFlashOverlay').forEach(el => el.remove());
    }

    if(startButton) startButton.addEventListener('click', startGame);
  </script>
</body>
</html>
