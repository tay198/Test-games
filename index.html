<!DOCTYPE html>
<html>
<head>
  <title>Taylan's Enhanced Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      --original-bg: linear-gradient(135deg, #e0f7fa, #c5e1a5);
      background: var(--original-bg);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start; /* Align to top to make space for more UI */
      min-height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      padding-top: 10px;
    }
    h1 {
      font-size: 1.8em;
      margin-top: 0;
      margin-bottom: 8px;
    }
    #scoreBoard, #highScoreBoard, #timer, #combo {
      margin: 3px;
      font-size: 17px;
      color: #333;
      min-height: 22px;
    }
    #highScoreBoard { color: #b8860b; }
    #combo.active {
        animation: comboPulse 0.3s ease-in-out;
        font-weight: bold;
    }
    @keyframes comboPulse {
        0% { transform: scale(1.1); color: gold; }
        50% { transform: scale(1.25); color: orange; }
        100% { transform: scale(1.1); color: gold; }
    }

    #visualTimer {
        width: 90vw;
        max-width: 450px;
        height: 10px;
        background-color: #ccc;
        border-radius: 5px;
        margin-bottom: 8px;
        overflow: hidden;
        border: 1px solid #bbb;
    }
    #visualTimerBar {
        width: 100%;
        height: 100%;
        background-color: #4CAF50;
        border-radius: 5px;
        transition: width 0.5s linear;
    }

    #gameArea {
      position: relative;
      width: 90vw;
      height: 60vh; /* Adjusted for more UI */
      max-width: 450px;
      max-height: 600px; /* Adjusted */
      background-color: #fff;
      border: 2px solid #333;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .item-face { /* Renamed from .face for clarity */
      position: absolute;
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s ease-out; /* For click effect */
    }
    .item-face:active {
        transform: scale(0.9);
    }
    .stacey-clicked { /* Simple animation for Stacey */
        animation: staceyGotClicked 0.3s ease-out forwards;
    }
    @keyframes staceyGotClicked {
        0% { transform: scale(1.1); opacity: 1;}
        100% { transform: scale(0.5); opacity: 0;}
    }

    .sparkle { /* Kept for original effect if desired, though stacey-clicked is more direct */
      animation: sparkle 0.6s ease-out forwards;
    }
    @keyframes sparkle {
      0% { transform: scale(1) rotate(0deg); opacity: 1; filter: brightness(1.2); }
      50% { transform: scale(1.6) rotate(15deg); opacity: 0.7; filter: brightness(1.5) drop-shadow(0 0 5px gold); }
      100% { transform: scale(0.8) rotate(-15deg); opacity: 0; filter: brightness(0.8); }
    }

    #startButton, #showInstructionsButton {
      margin-top: 8px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #startButton:hover, #showInstructionsButton:hover {
        background-color: #0056b3;
    }
    #startButton:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
    #gameOverMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px; /* Adjusted */
      color: white;
      background-color: rgba(180, 0, 0, 0.85); /* Darker red */
      padding: 20px;
      border-radius: 10px;
      font-weight: bold;
      z-index: 10000;
      display: none;
      text-align: center;
      line-height: 1.4;
    }
    .no-symbol-overlay { /* Renamed from blood-overlay */
      position: absolute;
      width: 70px;
      height: 70px;
      background-image: url('https://i.imgur.com/AhrFSJL.jpeg'); /* No symbol */
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 500;
      pointer-events: none;
      opacity: 0.8;
    }
    #screenFlashOverlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: red;
        opacity: 0;
        z-index: 499; /* Below no-symbol */
        pointer-events: none;
        animation: screenFlashAnim 0.4s ease-out;
    }
    @keyframes screenFlashAnim {
        0% { opacity: 0.6; }
        100% { opacity: 0; }
    }

    .score-popup {
      position: absolute;
      font-size: 22px;
      font-weight: bold;
      color: gold;
      text-shadow: 1px 1px 2px black;
      pointer-events: none;
      animation: scorePopupAnim 0.7s ease-out forwards;
      z-index: 100;
    }
    @keyframes scorePopupAnim {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
    }

    #instructionModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none; justify-content: center; align-items: center;
      z-index: 20000; padding: 15px; box-sizing: border-box;
    }
    #instructionModalContent {
      background-color: #fff; padding: 25px 30px; border-radius: 10px;
      text-align: center; max-width: 400px; width: 90%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #instructionModalContent h2 { margin-top: 0; color: #333; }
    #instructionModalContent p { margin-bottom: 20px; font-size: 1em; line-height: 1.5; color: #555; }
    #closeInstructionsButton {
      padding: 12px 25px; font-size: 1em; background-color: #007bff;
      color: white; border: none; border-radius: 5px; cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #closeInstructionsButton:hover { background-color: #0056b3; }

    #jailBarsOverlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: none; justify-content: space-around;
      overflow: hidden; z-index: 9000; pointer-events: none;
    }
    #jailBarsOverlay.active { display: flex; }
    .jail-bar {
      background-color: #2c3e50; border: 2px solid #34495e;
      width: 12%; /* Thinner bars */
      height: 0%;
      animation: dropJailBar 0.6s forwards ease-in-out;
    }
    .jail-bar:nth-child(1) { animation-delay: 0s; }
    .jail-bar:nth-child(2) { animation-delay: 0.05s; }
    .jail-bar:nth-child(3) { animation-delay: 0.1s; }
    .jail-bar:nth-child(4) { animation-delay: 0.15s; }
    .jail-bar:nth-child(5) { animation-delay: 0.2s; }
    .jail-bar:nth-child(6) { animation-delay: 0.25s; } /* More bars */
    .jail-bar:nth-child(7) { animation-delay: 0.3s; }

    @keyframes dropJailBar {
      from { height: 0%; transform: translateY(-100%);}
      to   { height: 100%; transform: translateY(0); }
    }

    /* Power-up specific styles */
    .powerup-icon {
        border: 3px solid gold !important;
        box-shadow: 0 0 10px gold;
    }
    #activePowerUpsDisplay {
        margin-top: 5px;
        font-size: 0.9em;
        color: #333;
        min-height: 20px;
        text-align: center;
    }
  </style>
</head>
<body>
  <h1>Taylan's Enhanced Game</h1>
  <div id="scoreBoard">Score: <span id="score">0</span></div>
  <div id="highScoreBoard">High Score: <span id="highScore">0</span></div>
  <div id="timer">Time: <span id="timeLeft">30</span>s</div>
  <div id="visualTimer"><div id="visualTimerBar"></div></div>
  <div id="combo" style="min-height: 24px;"></div>
  <div id="activePowerUpsDisplay"></div>

  <div id="gameArea">
    <div id="gameOverMessage"></div>
    <div id="jailBarsOverlay">
      <div class="jail-bar"></div><div class="jail-bar"></div><div class="jail-bar"></div>
      <div class="jail-bar"></div><div class="jail-bar"></div><div class="jail-bar"></div>
      <div class="jail-bar"></div>
    </div>
  </div>

  <audio id="gameMusic" src="https://github.com/tay198/Taylans-game-music/raw/refs/heads/main/AC_250601194725.mp3" loop></audio>
  <audio id="gameOverSound" src="https://github.com/tay198/Taylans-game-music/raw/refs/heads/main/END%20OF%20GAME%20SOUND.mp3"></audio>
  <audio id="staceyClickSound" src="YOUR_STACEY_CLICK_SOUND.mp3"></audio>
  <audio id="jakePenaltySound" src="YOUR_JAKE_PENALTY_SOUND.mp3"></audio>
  <audio id="powerUpSound" src="YOUR_POWERUP_COLLECT_SOUND.mp3"></audio>
  <audio id="bystanderSound" src="YOUR_BYSTANDER_HIT_SOUND.mp3"></audio>
  <audio id="comboSound" src="YOUR_COMBO_SOUND.mp3"></audio>
  <audio id="jailBarSound" src="YOUR_JAIL_BAR_SLAM_SOUND.mp3"></audio>


  <button id="startButton">Start Game</button>
  <button id="showInstructionsButton">How to Play</button>

  <div id="instructionModal">
    <div id="instructionModalContent">
      <h2>How to Play Taylan's Game!</h2>
      <p>Help Stacey collect... items... by clicking her image before time runs out!
      Each click on Stacey earns points and builds your combo for bigger scores.
      Avoid Officer Jake at all costs - clicking him means Game Over!
      Watch out for Innocent Bystanders too; clicking them will cost you points.
      Grab Power-Ups for special boosts!</p>
      <button id="closeInstructionsButton">Got It!</button>
    </div>
  </div>

  <script>
    const gameArea = document.getElementById('gameArea');
    const scoreDisplay = document.getElementById('score');
    const highScoreDisplay = document.getElementById('highScore');
    const timeDisplay = document.getElementById('timeLeft');
    const visualTimerBar = document.getElementById('visualTimerBar');
    const comboDisplay = document.getElementById('combo');
    const gameOverMessage = document.getElementById('gameOverMessage');
    const startButton = document.getElementById('startButton');
    const showInstructionsButton = document.getElementById('showInstructionsButton');
    const activePowerUpsDisplay = document.getElementById('activePowerUpsDisplay');

    const music = document.getElementById('gameMusic');
    const gameOverSoundEffect = document.getElementById('gameOverSound'); // Renamed to avoid conflict
    const staceyClickSfx = document.getElementById('staceyClickSound');
    const jakePenaltySfx = document.getElementById('jakePenaltySound');
    const powerUpSfx = document.getElementById('powerUpSound');
    const bystanderSfx = document.getElementById('bystanderSound');
    const comboSfx = document.getElementById('comboSound');
    const jailBarSfx = document.getElementById('jailBarSound');

    const instructionModal = document.getElementById('instructionModal');
    const closeInstructionsButton = document.getElementById('closeInstructionsButton');
    const jailBarsOverlay = document.getElementById('jailBarsOverlay');

    const staceyURL = 'https://i.imgur.com/qDTf6hn.jpeg';
    const jakeURL = 'https://i.imgur.com/hDQyFFS.jpeg';
    const bystanderURL = 'YOUR_BYSTANDER_IMAGE.png'; // Placeholder
    const timePowerUpURL = 'YOUR_TIME_POWERUP_IMAGE.png'; // Placeholder (e.g., a clock icon)
    const scorePowerUpURL = 'YOUR_SCORE_POWERUP_IMAGE.png'; // Placeholder (e.g., a star icon)

    const gameSettings = {
        initialTime: 30,
        baseSpawnInterval: 950, // ms
        minSpawnInterval: 400,  // Fastest spawn
        jakeBaseProb: 0.20,     // Initial probability of Jake
        jakeMaxProb: 0.40,      // Max probability of Jake
        powerUpProb: 0.10,      // Chance an item is a power-up
        bystanderProb: 0.15,    // Chance an item is a bystander (after not being Jake/PowerUp)
        pointsPerStacey: 5,
        comboBonusMultiplier: 2,
        bystanderPenalty: 10,
        timePowerUpValue: 5,    // seconds
        scorePowerUpDuration: 5000, // ms
        scorePowerUpMultiplier: 2,
        difficultyScoreThreshold: 100, // Score interval to increase difficulty
    };

    let score = 0;
    let highScore = 0;
    let timeLeft = gameSettings.initialTime;
    let gameInterval, spawnIntervalId; // Renamed spawnInterval to spawnIntervalId
    let gameActive = false;
    let hitJakeInGameOver = false; // To show specific game over

    let comboCount = 0;
    let comboTimeout;

    let flickerInterval = null;
    let originalBodyBackground = getComputedStyle(document.body).getPropertyValue('--original-bg');
    let isFlickerRed = false;
    let gameOverFlickerTimeout = null;

    let currentSpawnInterval = gameSettings.baseSpawnInterval;
    let currentJakeProb = gameSettings.jakeBaseProb;

    let activeScoreMultiplier = 1;
    let scoreMultiplierTimeout;

    // --- Utility Functions ---
    function playSound(soundElement) {
        if (soundElement && soundElement.src && soundElement.src !== window.location.href) { // Check if src is valid
            soundElement.currentTime = 0;
            soundElement.play().catch(error => console.warn("Audio play error:", error.message, soundElement.src));
        }
    }

    function createScorePopup(value, element) {
        const popup = document.createElement('div');
        popup.textContent = (value > 0 ? '+' : '') + value;
        popup.className = 'score-popup';
        popup.style.color = value > 0 ? 'gold' : 'red';
        popup.style.left = (element.offsetLeft + element.offsetWidth / 2 - 15) + 'px';
        popup.style.top = (element.offsetTop - 10) + 'px';
        gameArea.appendChild(popup);
        setTimeout(() => {
            if (popup.parentNode) popup.remove();
        }, 700);
    }

    function updateActivePowerUpsDisplay() {
        let displayHTML = "";
        if (activeScoreMultiplier > 1) {
            displayHTML += `Double Score Active! `;
        }
        // Add other power-ups here if they have visual indicators
        activePowerUpsDisplay.innerHTML = displayHTML;
    }


    // --- Instruction Modal Logic ---
    function showInstructions() {
      instructionModal.style.display = 'flex';
      startButton.disabled = true;
    }
    function hideInstructions() {
      instructionModal.style.display = 'none';
      localStorage.setItem('instructionsShown', 'true');
      startButton.disabled = false;
    }
    window.addEventListener('load', () => {
      loadHighScore();
      if (localStorage.getItem('instructionsShown') !== 'true') {
        showInstructions();
      } else {
        startButton.disabled = false;
      }
    });
    closeInstructionsButton.addEventListener('click', hideInstructions);
    showInstructionsButton.addEventListener('click', showInstructions);


    // --- High Score Logic ---
    function loadHighScore() {
        highScore = parseInt(localStorage.getItem('taylanGameHighScore') || '0');
        highScoreDisplay.textContent = highScore;
    }
    function saveHighScore() {
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('taylanGameHighScore', highScore.toString());
            highScoreDisplay.textContent = highScore;
        }
    }

    // --- Game Difficulty Scaling ---
    function updateDifficulty() {
        // Increase difficulty based on score
        const difficultyFactor = Math.floor(score / gameSettings.difficultyScoreThreshold);
        currentSpawnInterval = Math.max(gameSettings.minSpawnInterval, gameSettings.baseSpawnInterval - difficultyFactor * 50);
        currentJakeProb = Math.min(gameSettings.jakeMaxProb, gameSettings.jakeBaseProb + difficultyFactor * 0.02);

        // Reschedule spawn with new interval if it's active
        if (gameActive && spawnIntervalId) {
            clearInterval(spawnIntervalId);
            spawnIntervalId = setInterval(spawnItem, currentSpawnInterval);
        }
    }


    // --- Item Spawning Logic ---
    function spawnItem() {
      if (!gameActive) return;

      let itemType = 'stacey';
      let itemURL = staceyURL;
      let points = gameSettings.pointsPerStacey;
      let isPowerUp = false;
      let powerUpType = null;

      const rand = Math.random();

      if (rand < currentJakeProb) {
        itemType = 'jake';
        itemURL = jakeURL;
      } else if (rand < currentJakeProb + gameSettings.powerUpProb) {
        isPowerUp = true;
        if (Math.random() < 0.5) { // 50/50 chance for time or score power-up
            itemType = 'timePowerUp';
            itemURL = timePowerUpURL;
            powerUpType = 'time';
        } else {
            itemType = 'scorePowerUp';
            itemURL = scorePowerUpURL;
            powerUpType = 'score';
        }
      } else if (rand < currentJakeProb + gameSettings.powerUpProb + gameSettings.bystanderProb) {
        itemType = 'bystander';
        itemURL = bystanderURL;
      }

      const img = document.createElement('img');
      img.src = itemURL;
      img.classList.add('item-face');
      if (isPowerUp) img.classList.add('powerup-icon');
      img.setAttribute('draggable', 'false');
      img.dataset.itemType = itemType; // Store type for click handler

      const itemSize = 60;
      const x = Math.random() * (gameArea.clientWidth - itemSize);
      const y = Math.random() * (gameArea.clientHeight - itemSize);
      img.style.left = x + 'px';
      img.style.top = y + 'px';

      img.addEventListener('click', (event) => {
        if (!gameActive) return;

        const clickedItemType = img.dataset.itemType;

        if (clickedItemType === 'jake') {
          playSound(jakePenaltySfx);
          const noSymbol = document.createElement('div');
          noSymbol.className = 'no-symbol-overlay';
          noSymbol.style.left = (img.offsetLeft + (img.offsetWidth / 2) - 35) + 'px';
          noSymbol.style.top = (img.offsetTop + (img.offsetHeight / 2) - 35) + 'px';
          gameArea.appendChild(noSymbol);

          // Screen flash
          const flash = document.createElement('div');
          flash.id = 'screenFlashOverlay'; // Will reuse if one is fading
          if (document.getElementById('screenFlashOverlay')) {
            document.getElementById('screenFlashOverlay').remove();
          }
          gameArea.appendChild(flash);


          if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
          hitJakeInGameOver = true;
          endGame();
        } else if (clickedItemType === 'stacey') {
          playSound(staceyClickSfx);
          img.classList.add('stacey-clicked'); // Use new animation

          comboCount++;
          const pointsEarned = points * (comboCount > 1 ? gameSettings.comboBonusMultiplier : 1) * activeScoreMultiplier;
          score += pointsEarned;
          scoreDisplay.textContent = score;
          createScorePopup(pointsEarned, img);

          comboDisplay.textContent = comboCount > 1 ? `Combo: ${comboCount}x!` : '';
          if (comboCount > 1) {
            playSound(comboSfx);
            comboDisplay.classList.add('active');
            setTimeout(() => comboDisplay.classList.remove('active'), 300);
          }

          clearTimeout(comboTimeout);
          comboTimeout = setTimeout(() => {
            comboCount = 0;
            comboDisplay.textContent = '';
          }, 2000);

          if (navigator.vibrate) navigator.vibrate(30);
          updateDifficulty(); // Check if difficulty needs to increase
        } else if (clickedItemType === 'bystander') {
            playSound(bystanderSfx);
            score = Math.max(0, score - gameSettings.bystanderPenalty); // Don't go below 0
            scoreDisplay.textContent = score;
            createScorePopup(-gameSettings.bystanderPenalty, img);
            comboCount = 0; // Reset combo
            comboDisplay.textContent = '';
            if (navigator.vibrate) navigator.vibrate(50);
        } else if (clickedItemType === 'timePowerUp') {
            playSound(powerUpSfx);
            timeLeft += gameSettings.timePowerUpValue;
            timeDisplay.textContent = timeLeft;
            createScorePopup(`+${gameSettings.timePowerUpValue}s`, img);
        } else if (clickedItemType === 'scorePowerUp') {
            playSound(powerUpSfx);
            activeScoreMultiplier = gameSettings.scorePowerUpMultiplier;
            updateActivePowerUpsDisplay();
            createScorePopup(`x${gameSettings.scorePowerUpMultiplier} Score!`, img);
            clearTimeout(scoreMultiplierTimeout);
            scoreMultiplierTimeout = setTimeout(() => {
                activeScoreMultiplier = 1;
                updateActivePowerUpsDisplay();
            }, gameSettings.scorePowerUpDuration);
        }

        img.style.pointerEvents = 'none'; // Prevent multi-clicks
        if (clickedItemType !== 'stacey') { // Stacey has its own removal animation
            setTimeout(() => {
                if (img.parentNode) img.remove();
            }, isPowerUp ? 100 : 600); // Power-ups disappear faster
        } else {
             setTimeout(() => { // Ensure stacey-clicked elements are removed
                if (img.parentNode) img.remove();
            }, 300); // Match animation duration
        }
      });

      gameArea.appendChild(img);
      // Auto-remove if not clicked (except Jake who stays)
      if (itemType !== 'jake') {
        setTimeout(() => {
          if (gameArea.contains(img) && !img.classList.contains('stacey-clicked') && img.style.pointerEvents !== 'none') {
              if (itemType === 'stacey') { // Only reset combo if Stacey is missed
                  comboCount = 0;
                  comboDisplay.textContent = '';
                  clearTimeout(comboTimeout);
              }
              gameArea.removeChild(img);
          }
        }, itemType === 'bystander' || isPowerUp ? 2500 : 1800); // Bystanders/Powerups stay a bit longer
      }
    }

    function updateTimer() {
      timeLeft--;
      timeDisplay.textContent = timeLeft;
      const percentageLeft = (timeLeft / gameSettings.initialTime) * 100;
      visualTimerBar.style.width = percentageLeft + '%';
      if (percentageLeft < 25) visualTimerBar.style.backgroundColor = '#f44336'; // Red
      else if (percentageLeft < 50) visualTimerBar.style.backgroundColor = '#ffeb3b'; // Yellow


      if (timeLeft <= 0) {
        hitJakeInGameOver = false; // Time's up, not Jake
        endGame();
      }
    }

    function toggleBackgroundColorFlicker() {
        if (isFlickerRed) {
            document.body.style.background = 'rgba(0,0,255,0.3)'; // Blue
        } else {
            document.body.style.background = 'rgba(255,0,0,0.3)'; // Red
        }
        isFlickerRed = !isFlickerRed;
    }

    function startGame() {
      if (gameOverFlickerTimeout) {
        clearTimeout(gameOverFlickerTimeout);
        gameOverFlickerTimeout = null;
        document.body.style.background = originalBodyBackground; // Ensure reset
      }

      gameOverSoundEffect.pause();
      gameOverSoundEffect.currentTime = 0;
      if (jailBarSfx.src !== window.location.href) { // valid src check
        jailBarSfx.pause();
        jailBarSfx.currentTime = 0;
      }


      gameActive = true;
      hitJakeInGameOver = false;
      score = 0;
      timeLeft = gameSettings.initialTime;
      comboCount = 0;
      activeScoreMultiplier = 1;
      currentSpawnInterval = gameSettings.baseSpawnInterval;
      currentJakeProb = gameSettings.jakeBaseProb;

      scoreDisplay.textContent = score;
      timeDisplay.textContent = timeLeft;
      visualTimerBar.style.width = '100%';
      visualTimerBar.style.backgroundColor = '#4CAF50';
      comboDisplay.textContent = '';
      gameOverMessage.style.display = 'none';
      jailBarsOverlay.classList.remove('active');
      document.querySelectorAll('#jailBarsOverlay .jail-bar').forEach(b => {
          b.style.animation = 'none'; // Reset animation before re-adding
          setTimeout(() => b.style.animation = '', 0); // Re-apply for next game over
          b.style.height = '0%'; // Explicitly hide
      });

      updateActivePowerUpsDisplay();
      clearTimeout(scoreMultiplierTimeout);


      startButton.textContent = 'Game in Progress...';
      startButton.disabled = true;

      clearGameElements();

      music.play().catch(error => console.warn("Music play error:", error.message));

      if (flickerInterval) {
        clearInterval(flickerInterval);
        flickerInterval = null;
      }
      isFlickerRed = false;
      toggleBackgroundColorFlicker();
      flickerInterval = setInterval(toggleBackgroundColorFlicker, 300);

      if(spawnIntervalId) clearInterval(spawnIntervalId); // Clear previous if any
      spawnIntervalId = setInterval(spawnItem, currentSpawnInterval);
      if(gameInterval) clearInterval(gameInterval); // Clear previous if any
      gameInterval = setInterval(updateTimer, 1000);
    }

    function endGame() {
      const wasAlreadyOver = !gameActive;
      gameActive = false;

      clearInterval(spawnIntervalId);
      clearInterval(gameInterval);
      clearTimeout(comboTimeout);
      clearTimeout(scoreMultiplierTimeout); // Clear active power-ups

      saveHighScore(); // Save score before displaying message

      // Display Game Over Message
      if (hitJakeInGameOver) {
          gameOverMessage.innerHTML = `BUSTED!<br>You hit Jake!<br>Final Score: ${score}`;
          playSound(jailBarSfx);
          jailBarsOverlay.classList.add('active');
      } else { // Time's up
          gameOverMessage.innerHTML = `Time's Up!<br>Stacey got away!<br>Final Score: ${score}`;
      }
      gameOverMessage.style.display = 'block';


      startButton.textContent = 'Restart Game';
      startButton.disabled = false;

      music.pause();
      music.currentTime = 0;

      if (!wasAlreadyOver) {
          playSound(gameOverSoundEffect);
      }

      if (!gameOverFlickerTimeout) {
        gameOverFlickerTimeout = setTimeout(() => {
          if (flickerInterval) {
              clearInterval(flickerInterval);
              flickerInterval = null;
          }
          document.body.style.background = originalBodyBackground;
          gameOverFlickerTimeout = null;
        }, 7000); // Reduced flicker time after game over
      }
    }

    function clearGameElements() {
        gameArea.querySelectorAll('.item-face, .no-symbol-overlay, .score-popup, #screenFlashOverlay').forEach(el => el.remove());
    }

    startButton.addEventListener('click', startGame);

  </script>
</body>
</html>
